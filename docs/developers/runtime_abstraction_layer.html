

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Runtime Abstraction Layer Introduction &mdash; BladeDISC 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

</head>

<body>
    <header>
        <div class="container">
            <a class="site-nav-toggle hidden-lg-up"><i class="icon-menu"></i></a>
            <a class="site-title" href="../../index.html">
                BladeDISC
            </a>
        </div>
    </header>


<div class="breadcrumbs-outer hidden-xs-down">
    <div class="container">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="breadcrumbs">
    
      <li><a href="../../index.html">Docs</a></li>
        
      <li>Runtime Abstraction Layer Introduction</li>
    
    
      <li class="breadcrumbs-aside">
        
            
            <a href="../../_sources/docs/developers/runtime_abstraction_layer.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>
</div>
    </div>
</div>
    <div class="main-outer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-3 site-nav">
                    
<div role="search">
    <form class="search" action="../../search.html" method="get">
        <div class="icon-input">
            <input type="text" name="q" placeholder="Search" />
            <span class="icon-search"></span>
        </div>
        <input type="submit" value="Go" class="d-hidden" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
                    <div class="site-nav-tree">
                        
                            
                            
                                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">BladeDISC Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#api-quickview">API QuickView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#setup-and-examples">Setup and Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#publications">Publications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#tutorials-and-documents-for-developers">Tutorials and Documents for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#presentations-and-talks">Presentations and Talks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#how-to-contribute">How to Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#building-status">Building Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#faq">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#contact-us">Contact Us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../install_with_docker.html">Install with Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install_with_docker.html#download-a-bladedisc-docker-image">Download a BladeDISC Docker Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install_with_docker.html#start-a-docker-container">Start a Docker Container</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../build_from_source.html">Build from Source</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../build_from_source.html#prerequisite">Prerequisite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_from_source.html#checkout-the-source">Checkout the Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_from_source.html#launch-a-development-docker-container">Launch a development Docker container</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_from_source.html#building-bladedisc-for-tensorflow-users">Building BladeDISC for TensorFlow Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../build_from_source.html#building-bladedisc-for-pytorch-users">Building BladeDISC for PyTorch Users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#quickstart-for-tensorflow-users">Quickstart for TensorFlow Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#quickstart-for-pytorch-users">Quickstart for PyTorch Users</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">How to Contribute</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../contribution.html#local-development-environment">Local Development Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contribution.html#submit-a-pull-request-to-bladedisc">Submit a Pull Request to BladeDISC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials on Example Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/tensorflow_inference_and_training.html">Use case of TensorFlow Inference and Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/torch_bert_inference.html">Use case of PyTorch Inference</a></li>
</ul>
</li>
</ul>

                            
                        
                    </div>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="document">
                        
                            
  <section id="runtime-abstraction-layer-introduction">
<h1>Runtime Abstraction Layer Introduction<a class="headerlink" href="#runtime-abstraction-layer-introduction" title="Permalink to this heading">¶</a></h1>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this heading">¶</a></h2>
<p>BladeDISC is an MHLO based e2e compiler with the consideration of both the
compiler and the associated runtime. For the runtime side, we have different
targeting environments (e.g. TensorFlow, PyTorch, or sometimes even a standalone
binary). To simplify the design of the compiler side, we leverage a Runtime
Abstraction Layer (RAL) to separate the compiler and runtime. Thus
the compiler side only needs to target RAL and relies on it to handle the
differences between different targeting environments.</p>
<p>Another function of RAL is to manage stateful resources. To this end, it
provides a context object and hides all stateful operations behind this context,
thus the compiler side itself doesn’t need to care about the resource
initialization. For example, a kernel must be loaded before it can be launched
on GPU. However, the loading operation should only be taken once during the
whole lifetime of the context in order to achieve the best performance. Based on
the initialization-free interfaces (for example, load the kernel if it has not
been loaded and then launch) provided by RAL, the compiler side can focus on its
core optimization logic and lets the RAL manage the resource status.</p>
</section>
<section id="design-overview">
<h2>Design Overview<a class="headerlink" href="#design-overview" title="Permalink to this heading">¶</a></h2>
<section id="from-the-perspective-of-compiler-side">
<h3>From the Perspective of Compiler Side<a class="headerlink" href="#from-the-perspective-of-compiler-side" title="Permalink to this heading">¶</a></h3>
<p>In the compiler side, there is a set of transformation passes for RAL to make
sure the compiled binary is suitable for the RAL runtime.</p>
<section id="context-injection">
<h4>Context Injection<a class="headerlink" href="#context-injection" title="Permalink to this heading">¶</a></h4>
<p>As mentioned above, we prefer to simplify the design of the compiler side and
let it focus on its core optimization logic. Thus, RAL provides a context object
to hide all stateful operations behind the context. The context is passed as a
argument to the entry function of the compilation module and all RAL APIs
should always use the context as their first argument. RAL uses a context
injection pass to ensure this property. The pass rewrites the entry function and
all related functions to make sure their first argument is the context. To be
concrete, we create a custom dialect disc_ral using MLIR infra to model the RAL
runtime behavior. Inside the dialect, we define a custom type
disc_ral.RalExecutionContextType to represent the context type in the compiler
side. Under the hood, the disc_ral.RalExecutionContextType will be lowered to a
pointer type in LLVM IR.</p>
</section>
<section id="inputs-outputs-binding">
<h4>Inputs/Outputs Binding<a class="headerlink" href="#inputs-outputs-binding" title="Permalink to this heading">¶</a></h4>
<p>For the entry function, RAL also rewrites its inputs and outputs to make it
suitable to interact with different host environments. To be concrete, all the
original inputs and outputs of the entry function are received from and sent to
RAL through a sequence of RAL API calls correspondingly. The motivation behind
this is to hide the implementation details of the MemRef structure to make the
ABI clean and stable. Below is the example IR before and after the
transformation.</p>
<p>Original IR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>func @main(%arg0 : memref&lt;?x?xf32&gt;, %arg1 : memref&lt;?x?xf32&gt;) -&gt; memref&lt;?x?xf32&gt; {
  %ret = alloc(...)
  use(%arg0, %arg1, %ret, ...)
  return %ret : memref&lt;?x?xf32&gt;
}
</pre></div>
</div>
<p>After conversion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>func @main(!disc_ral.context %ctx) {
  %arg0 = disc_ral.recv_input(%ctx, 0) // receive the first input
  %arg1 = disc_ral.recv_input(%ctx, 1) // receive the second input
  %ret = alloc(...)
  use(%arg0, %arg1, %ret, ...)
  disc_ral.send_output(%ctx, 0, %ret) // send the first outpt
}
</pre></div>
</div>
<p>As shown in the above example, the inputs (similar to the outputs) are received
from the RAL context one by one. We could choose to use one API call to receive
all inputs at the same time, which may also have lower runtime overhead in terms
of the number of RAL API calls. However, the current design lets the compiler
have the opportunity to adjust the placement of each recv_input and send_output
API to achieve partial execution of a compiled binary before all its inputs are
ready and sending some of the outputs to the context before all its outputs are
ready.</p>
</section>
<section id="uniformed-type-erased-external-function-call-abi">
<h4>Uniformed type-erased external function call ABI<a class="headerlink" href="#uniformed-type-erased-external-function-call-abi" title="Permalink to this heading">¶</a></h4>
<p>To make the compiled binary have stable and clean ABI, RAL provides a pass to
rewrite all RAL function calls to a uniformed type-erased style.</p>
<p>A RAL function is an ordinary c++ function that satisfies the following
requirements.</p>
<ul class="simple">
<li><p>The first argument of the function should be a pointer to the RAL context.</p></li>
<li><p>RAL supports type bool, int8/16/32/64, half/float/double, MemRef struct, and
ordinary pointer.</p></li>
<li><p>The types of remaining arguments should be supported by RAL.</p></li>
<li><p>The returning type should be supported by RAL.</p></li>
</ul>
<p>For a given RAL function, it has an equivalent interface, namely a type-erased c
language interface. The main purpose of this kind of interface is used for
cross-language binding and linking.</p>
<p>Below is an example to demonstrate the c++ format and corresponding uniform
type-erased format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">A</span> <span class="n">RAL</span> <span class="n">API</span> <span class="n">to</span> <span class="n">do</span> <span class="n">GEMM</span> <span class="n">operation</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span> <span class="nb">format</span>
<span class="n">void</span> <span class="n">gemm</span><span class="p">(</span><span class="n">RalContext</span><span class="o">*</span><span class="p">,</span> <span class="n">gpu_stream_handle</span><span class="o">*</span><span class="p">,</span> <span class="n">MemRef</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">MemRef</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">MemRef</span><span class="o">&lt;</span><span class="nb">float</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">out</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">lhs_transposed</span><span class="p">,</span> <span class="nb">bool</span> <span class="n">rhs_transposed</span><span class="p">);</span>

<span class="o">//</span> <span class="o">----======================================</span>
<span class="o">//</span> <span class="n">Uniform</span> <span class="nb">type</span><span class="o">-</span><span class="n">erased</span> <span class="n">c</span> <span class="nb">format</span>
<span class="o">//</span>   <span class="n">the</span> <span class="mi">1</span><span class="n">st</span> <span class="n">arg</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">ral</span> <span class="n">context</span> <span class="n">by</span> <span class="n">design</span>
<span class="o">//</span>   <span class="n">the</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">arg</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">full</span> <span class="n">name</span> <span class="n">of</span> <span class="n">a</span> <span class="n">ral</span> <span class="n">api</span>
<span class="o">//</span>   <span class="n">the</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">arg</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">which</span> <span class="n">points</span> <span class="n">to</span> <span class="n">the</span> <span class="n">arguments</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ral</span> <span class="n">api</span>
<span class="o">//</span>
<span class="o">//</span>   <span class="n">RAL</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">following</span> <span class="n">schema</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">full</span> <span class="n">name</span> <span class="n">of</span> <span class="n">a</span> <span class="n">ral</span> <span class="n">function</span><span class="p">:</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">encoding</span> <span class="o">=</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">inputs_encode</span><span class="p">,</span>
<span class="o">//</span>     <span class="n">outputs_encode</span><span class="p">)</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;___&#39;</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">target_name</span><span class="p">:</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">external</span> <span class="n">function</span> <span class="n">to</span> <span class="n">dispatch</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">device</span><span class="p">:</span> <span class="n">user</span> <span class="n">defined</span> <span class="n">string</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">cpu</span> <span class="ow">or</span> <span class="n">gpu</span><span class="p">)</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">inputs_encode</span> <span class="o">=</span> <span class="n">type_separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">type_encoding</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span>
<span class="o">//</span>     <span class="n">input_types</span><span class="p">])</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">outputs_encode</span> <span class="o">=</span> <span class="n">type_separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">type_encoding</span> <span class="k">for</span> <span class="nb">type</span>
<span class="o">//</span>     <span class="ow">in</span> <span class="n">output_types</span><span class="p">])</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">type_separator</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>

<span class="o">//</span> <span class="n">The</span> <span class="n">dispatcher</span> <span class="n">will</span> <span class="n">dispatch</span> <span class="n">to</span> <span class="n">concret</span> <span class="n">RAL</span> <span class="n">function</span> <span class="n">implementation</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">api_name</span>
<span class="n">void</span> <span class="n">ral_api_call</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">api_name</span><span class="p">,</span> <span class="n">void</span><span class="o">**</span> <span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<p>Furthermore, we also provide a registry mechanism to automatically convert a RAL
function from its c++ format to its uniform format. Below is an example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// A RAL API to do GEMM operation, c++ format
template &lt;typename T&gt;
void gemm(RalContext*, gpu_stream_handle*, MemRef&lt;T, 2&gt; lhs, MemRef&lt;T, 2&gt; rhs, MemRef&lt;T, 2&gt; out, bool lhs_transposed, bool, rhs_transposed);

// ----====================================

// register a new RAL API using macro `TAO_RAL_API`.
//   Usage: TAO_RAL_API(api_prefix, device, api_function);
//   - generate a unique name based on the prefix provided and the types of inputs and outputs of the function.
//   - automatically provide a uniform interface wrapper
//   - register the wrapper function using the unique name generated.

// register ral_gemm with float type
TAO_RAL_API(&quot;ral_gemm&quot;, &quot;cpu&quot;, gemm&lt;float&gt;)
// register ral_gemm with half type
TAO_RAL_API(&quot;ral_gemm&quot;, &quot;gpu&quot;, gemm&lt;half&gt;)
</pre></div>
</div>
<p>Thus, based on the mechanism in the compiler side and the mechanism in the c++
side, users don’t need to worry about the details of c interface implementation
and can use the c++ level API directly.</p>
</section>
</section>
<section id="from-the-perspective-of-runtime-side">
<h3>From the Perspective of Runtime Side<a class="headerlink" href="#from-the-perspective-of-runtime-side" title="Permalink to this heading">¶</a></h3>
<section id="overview-of-the-runtime-side-of-ral">
<h4>Overview of the Runtime Side of RAL<a class="headerlink" href="#overview-of-the-runtime-side-of-ral" title="Permalink to this heading">¶</a></h4>
<p>The runtime side of the RAL can be divided into three major parts as shown in
the following <img alt="diagram" src="../../_images/RAL.png" />.</p>
<ul class="simple">
<li><p>Interacting with the host environments (e.g. Tensorflow, PyTorch). This part
usually includes i/o bindings and other bookkeeping stuff. We need different
implementations of this part for different hosting environments.</p></li>
<li><p>Providing an implementation of the initialization-free driver API for each kind
of device. In RAL, each kind of device defines its own core set of driver
APIs. The driver usually includes memory management, task launching, and
synchronization. It’s worth noting that we need different driver
implementations for the same device type in different host environments. One
rationale is that different host environments usually have different device
abstraction layers, leading to different API styles and semantics. Another
reason is that using the host environment native device resource access style
could also minimize the overhead when crossing the host environment and RAL
boundary.</p></li>
<li><p>Providing an implementation of the custom kernel. Examples are vendor library
kernel, RNG, TopK, or sort op. These kernels are usually not generated by
BladeDISC and rely on some manually crafted implementations. It is worth
noting that the custom kernel itself uses the RAL driver API to access device
resources, and thus can be shared among different host environments since the
RAL driver has already hidden the differences among different host
environments.</p></li>
</ul>
</section>
<section id="ral-context">
<h4>RAL Context<a class="headerlink" href="#ral-context" title="Permalink to this heading">¶</a></h4>
<p>We provide different RAL Context implementations for different target host
environments. The context implementation consists of the above three major
parts. Currently, we have TF context implementation, which is used to be
integrated with TensorFlow (both CPU &amp; GPU), and base context implementation,
which is used to be integrated with PyTorch and sometimes the standalone binary.</p>
</section>
<section id="ral-execution-context">
<h4>RAL Execution Context<a class="headerlink" href="#ral-execution-context" title="Permalink to this heading">¶</a></h4>
<p>For a loaded compiled binary, we have one corresponding RAL context to manage
the stateful resources and some bookkeeping stuff.  The context lifetime is the
same as the loaded compiler binary. RAL execution context is a wrapper of RAL
context and is designed to do bookkeeping for a single execution of the compiled
binary. Whenever we call the compiled binary, we first create an execution
context from the RAL context and then feed the execution context instead of the
context to the entry function of the compiled binary. This design is more
friendly and efficient for multi-thread execution situations.</p>
</section>
</section>
</section>
</section>


                        
                    </div>
                </div>
            </div>
        </div>
    </div>    


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  
    <div class="footer" role="contentinfo">
        <div class="container">
            &#169; Copyright bladedisc-dev@list.alibaba-inc.com.
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.
        </div>
    </div>  

</body>
</html>