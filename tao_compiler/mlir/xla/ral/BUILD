# RAL implementations

load(
    "@org_tensorflow//tensorflow:tensorflow.bzl",
    "tf_cc_shared_object",
    "tf_cc_test",
    "tf_copts",
    "tf_gpu_kernel_library",
    "tf_gpu_library",
    "tf_native_cc_binary",
)
load(
    "@local_config_cuda//cuda:build_defs.bzl",
    "cuda_default_copts",
    "if_cuda",
    "if_cuda_is_configured",
    "cuda_library",
)
load("@local_config_rocm//rocm:build_defs.bzl", "if_rocm_is_configured")
load(
    "@com_google_protobuf//:protobuf.bzl",
    "cc_proto_library",
)
load("//tensorflow/compiler/mlir/disc:disc.bzl",
     "disc_cc_library",
     "if_cuda_or_rocm",
     "if_platform_alibaba",
     "if_patine",
     "if_blade_gemm",
     "if_mkldnn",
     "if_disc_aarch64",
     "if_disc_x86",
     "if_torch_disc",
)

package(
    default_visibility = ["//visibility:public"],
    licenses = ["notice"],  # Apache 2.0
)

cc_library(
    name = "ral_logging",
    srcs = [
        "ral_logging.cc",
    ],
    hdrs = [
        "ral_logging.h",
    ],
    deps = [
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_md5",
    srcs = [
        "ral_md5.cc",
    ],
    hdrs = [
        "ral_md5.h",
    ],
    deps = [
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_context",
    srcs = [
        "ral_context.cc",
        "ral_helper.cc",
    ],
    hdrs = [
        "ral_context.h",
        "ral_helper.h",
        "ral_driver.h",
        "ral_base.h",
    ],
    deps = [
        ":ral_logging",
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_cpu_driver",
    srcs = ["device/cpu/cpu_driver.cc"],
    hdrs = ["device/cpu/cpu_driver.h"],
    deps = [
        ":ral_context",
        ":ral_logging"
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_gpu_driver",
    srcs = ["device/gpu/gpu_driver.cc"],
    hdrs = ["device/gpu/gpu_driver.h"],
    deps = [
        ":ral_context",
        ":ral_logging"
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_library",
    srcs = ["ral_api.cc"],
    hdrs = ["ral_api.h"],
    deps = [
        ":ral_context",
        ":ral_logging",
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_tf_context",
    srcs = [
        "context/tensorflow/tf_context_impl.cc",
        "context/tensorflow/tf_kernel_impl.cc",
    ],
    hdrs = ["context/tensorflow/tf_context_impl.h"],
    deps = [
        ":context_util",
        ":common_context",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_gpu_driver",
        ":ral_library",
        "//tensorflow/core:framework",
        "//tensorflow/stream_executor",
        "//tensorflow/core:lib",
        "@local_config_cuda//cuda:cuda_headers",
    ],
    alwayslink = 1,
)

cc_library(
    name = "context_util",
    srcs = [],
    hdrs = ["context/context_util.h"],
    deps = [
        ":ral_context",
        ":ral_logging"
    ],
    alwayslink = 1,
)

cc_library(
    name = "pdll_util",
    srcs = ["context/pdll_util.cc"],
    hdrs = ["context/pdll_util.h"],
    deps = [
        ":ral_context",
        ":ral_logging",
    ],
    alwayslink = 1,
)

cc_library(
    name = "ral_metadata",
    srcs = ["ral_metadata.cc"],
    hdrs = ["ral_metadata.h"],
    deps = [],
    alwayslink = 1,
)

tf_cc_test(
    name = "ral_metadata_test",
    size = "small",
    srcs = [
        "ral_metadata_test.cc",
    ],
    deps = [
        ":ral_metadata",
        "//tensorflow/core:test_main",
        "//tensorflow/core:test",
        "//tensorflow/core:testlib",
    ],
)

cc_library(
    name = "real_disc_patine_client_deps",
    srcs = [],
    hdrs = [],
    copts = ["-Itao/third_party/PatineClient/build/install/include"],
    linkopts = [
      "-Ltao/third_party/PatineClient/build/install/lib64",
      "-Wl,--start-group tao/third_party/PatineClient/build/intel/lib/libmkl_intel_ilp64.a tao/third_party/PatineClient/build/intel/lib/libmkl_gnu_thread.a tao/third_party/PatineClient/build/intel/lib/libmkl_core.a -Wl,--end-group",
    ],
    deps = ["//tao/third_party/PatineClient:patine_client"],
)


cc_library(
    name = "disc_patine_client_deps",
    deps = if_platform_alibaba([":real_disc_patine_client_deps"])
)

cc_library(
    name = "blade_gemm_deps",
    deps = if_torch_disc(
        ["@blade_gemm//:blade_gemm"],
        ["//tao/blade_gemm:blade_gemm"],
    )
)
cc_library(
    name = "disc_blade_gemm_deps",
    deps = if_platform_alibaba([
        ":blade_gemm_deps"
    ]),
    alwayslink = 1,
)

# depend on mkldnn and onednn targets generated by cmake
cc_library(
    name = "disc_mkl_cmake",
    hdrs = glob([
        "context/mkldnn/ideep/*.hpp",
        "context/mkldnn/ideep/ideep/*.hpp",
        "context/mkldnn/ideep/ideep/operators/*.hpp",
    ]),
    linkopts = [
      "-L$(location //tao/third_party/mkldnn:build)/install/lib64",
      "-L$(location //tao/third_party/mkldnn:build)/intel/lib",
      "-Wl,--start-group",
      "$(location //tao/third_party/mkldnn:build)/install/lib64/libdnnl.a",
      "-Wl,--end-group",
    ] + if_disc_x86([
      "-Wl,--start-group",
      "$(location //tao/third_party/mkldnn:build)/intel/lib/libmkl_intel_ilp64.a",
      "$(location //tao/third_party/mkldnn:build)/intel/lib/libmkl_gnu_thread.a",
      "$(location //tao/third_party/mkldnn:build)/intel/lib/libmkl_core.a",
      "-Wl,--end-group",
    ]) + if_disc_aarch64([
      "-Wl,--start-group",
      "$(location //tao/third_party/mkldnn:build)/acl/ComputeLibrary/build/libarm_compute.a",
      "$(location //tao/third_party/mkldnn:build)/acl/ComputeLibrary/build/libarm_compute_core.a",
      "$(location //tao/third_party/mkldnn:build)/acl/ComputeLibrary/build/libarm_compute_graph.a",
      "-Wl,--end-group",
    ]),
    data = ["//tao/third_party/mkldnn:build"],
    deps = if_disc_x86([
        "//tao/third_party/mkldnn:onednn",
    ]) + if_disc_aarch64([
        "//tao/third_party/mkldnn:onednn_acl",
    ]),
)

# depend on mkldnn and onednn from bazel workspace
cc_library(
    name = "disc_mkl_bazel",
    hdrs = glob([
        "context/mkldnn/ideep/*.hpp",
        "context/mkldnn/ideep/ideep/*.hpp",
        "context/mkldnn/ideep/ideep/operators/*.hpp",
    ]),
    linkopts = [
      "-Wl,--start-group",
      "$(locations @onednn//:onednn_lib)",
      "-Wl,--end-group",
      "-lgomp -lpthread -lm -ldl",
    ] + if_disc_x86([
        "-Wl,--start-group",
        "$(location @mkl_static//:lib)/libmkl_intel_ilp64.a",
        "$(location @mkl_static//:lib)/libmkl_gnu_thread.a",
        "$(location @mkl_static//:lib)/libmkl_core.a",
        "-Wl,--end-group",
    ]) + if_disc_aarch64([
        "-Wl,--start-group",
        "$(location @acl_compute_library//:build)/libarm_compute.a",
        "$(location @acl_compute_library//:build)/libarm_compute_core.a",
        "$(location @acl_compute_library//:build)/libarm_compute_graph.a",
        "-Wl,--end-group",
    ]),
    data = [
        "@onednn//:onednn_lib",
    ] + if_disc_x86([
        "@mkl_static//:lib",
    ]) + if_disc_aarch64([
        "@acl_compute_library//:build",
    ]),
    deps = [
        "@onednn//:onednn",  # acl is not needed in `deps` since the dependency is carried by `onednn`
    ] + if_disc_x86([
        "@mkl_include//:mkl_include",
        # "@mkl_static//:mkl_static_lib",
    ]),
    alwayslink = 1,
)

cc_library(
    name = "common_context",
    srcs = [
        "context/common_context_impl.cc",
        "context/common_context_impl_pdll.cc",
    ] + if_cuda_or_rocm([
        "context/common_context_impl_cuda.cc",
        "context/stream_executor_based_impl.cc",
    ]) + if_cuda([
        "context/cuda_impl_sparse.cc",
        "context/quantized_gpu_kernel_impl.cc",
    ]) + if_patine([
        "context/common_context_impl_patine.cc",
    ]) + if_mkldnn([
        "context/common_context_impl_mkldnn.cc",
        "context/common_context_impl_quantization.cc",
    ]) + if_disc_aarch64([
        "context/common_context_impl_acl.cc",
    ]),
    hdrs = [
        "context/common_context_impl.h",
    ] + if_cuda_or_rocm([
        "context/stream_executor_based_impl.h",
    ]) + if_mkldnn([
        "context/common_context_impl_mkldnn.h",
    ]) + if_disc_aarch64([
        "context/common_context_impl_acl.h",
    ]),
    copts = [
        # "-DTF_1_12",
        "-fopenmp",
    ] + if_cuda_or_rocm(["-DTAO_RAL_USE_STREAM_EXECUTOR"]),
    linkopts = [
        "-fopenmp",
        "-ldl",
        "-lm"
    ],
    deps = [
        ":pdll_util",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_logging",
        ":ral_metadata",
        ":context_util",
        "@com_google_absl//absl/strings"
    ] + if_cuda_is_configured([
        "//tensorflow/stream_executor:cuda_platform",
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "//tensorflow/stream_executor:rocm_platform",
        "//tensorflow/stream_executor/rocm:rocm_driver",
        "@local_config_rocm//rocm:rocm_headers",
    ]) + if_cuda_or_rocm([
        ":ral_gpu_driver",
        "//tensorflow/core:lib",
        "//tensorflow/core:stream_executor_headers_lib",
        "//tensorflow/core:framework",
    ]) + if_patine([
        ":disc_patine_client_deps",
    ]) + if_blade_gemm([
        ":disc_blade_gemm_deps",
    ]) + if_mkldnn([
        ":disc_mkl_cmake",
        ":ral_md5",
    ]),
    alwayslink = 1,
)

tf_gpu_library(
    name = "dynamic_sort",
    srcs = [
        "context/dynamic_sort_impl.cc",
    ],
    hdrs = [
        "context/dynamic_sort_impl.h",
    ],
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_logging",
        ":context_util",
        ":common_context",
        ":dynamic_sort_kernel",
    ] + if_cuda_is_configured([
        "@local_config_cuda//cuda:cuda_driver",
    ]) + if_rocm_is_configured([
        "//tensorflow/stream_executor/rocm:rocm_driver",
    ]),
    alwayslink = 1,
)

tf_cc_test(
    name = "philox_random_test",
    size = "small",
    srcs = [
        "context/custom_library/philox_random_test.cc",
        "context/custom_library/philox_random.h"
    ],
    deps = [
        "//tensorflow/core:test_main",
        "//tensorflow/core:test",
        "//tensorflow/core:testlib",
    ],
)

tf_gpu_kernel_library(
    name = "random_gpu_lib",
    srcs = [
        "context/custom_library/random_gpu.cu.cc",
    ],
    hdrs = [
        "context/custom_library/random.h",
        "context/custom_library/philox_random.h",
    ],
    copts = if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
    ]),
    deps = [
        "@local_config_cuda//cuda:cuda_headers",
    ],
)

cc_library(
    name = "random",
    srcs = [
        "context/random_impl.cc",
    ],
    hdrs = [
    ],
    #copts = ["-DTF_1_12"],
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_cpu_driver",
        ":ral_logging",
        ":context_util",
        ":random_gpu_lib",
        "//tensorflow/core:lib",
        "//tensorflow/core:stream_executor_headers_lib",
        "@com_google_absl//absl/strings",
    ] + if_cuda_is_configured([
        "//tensorflow/stream_executor:cuda_platform",
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "//tensorflow/stream_executor:rocm_platform",
        "//tensorflow/stream_executor/rocm:rocm_driver",
        "@local_config_rocm//rocm:rocm_headers",
    ]),
    alwayslink = 1,
)

tf_gpu_kernel_library(
    name = "transpose_gpu_lib",
    srcs = [
        "context/custom_library/transpose_gpu.cu.cc",
        "context/custom_library/tf_transpose.cu.h",
    ],
    hdrs = [
        "context/custom_library/transpose.h",
        "context/custom_library/dimensions.h",
        "context/custom_library/gpu_helper.h"
    ],
    includes = [
        "",
    ],
    copts = if_cuda_is_configured([
        "-DGOOGLE_CUDA=1"
    ]) + if_cuda_or_rocm([
        "-DTAO_RAL_USE_STREAM_EXECUTOR"
    ]),
    deps = if_cuda_is_configured([
        "@cub_archive//:cub",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
    #alwayslink = 1,
)

cc_library(
    name = "transpose",
    srcs = [
        "context/transpose_impl.cc",
    ],
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_cpu_driver",
        ":ral_logging",
        ":context_util",
        ":transpose_gpu_lib",
        "//tensorflow/core:lib",
        "//tensorflow/core:stream_executor_headers_lib",
        "@com_google_absl//absl/strings",
    ] + if_cuda_is_configured([
        "//tensorflow/stream_executor:cuda_platform",
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "//tensorflow/stream_executor:rocm_platform",
        "//tensorflow/stream_executor/rocm:rocm_driver",
        "@local_config_rocm//rocm:rocm_headers",
    ]),
    copts = if_cuda_is_configured([
        "-DGOOGLE_CUDA=1"
    ]) + if_cuda_or_rocm(["-DTAO_RAL_USE_STREAM_EXECUTOR"]),

    alwayslink = 1,
)

cc_library(
    name = "init_stream_executor",
    srcs = [
        "context/init_stream_executor.cc",
        "context/base/cuda/cuda_stream.cc"
    ],
    hdrs = [
        "context/init_stream_executor.h",
        "context/base/cuda/cuda_stream.h"
    ],
    deps = [
        ":common_context",
        ":ral_logging",
        "//tensorflow/core:lib",
        "@com_google_absl//absl/strings",
    ] + if_cuda_is_configured([
        "//tensorflow/stream_executor:cuda_platform",
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "//tensorflow/stream_executor:rocm_platform",
    ]),
    alwayslink = 1,
)

cc_library(
    name = "ral_base_cpu_context_impl",
    srcs = [
        "context/base/cpu/cpu_context_impl.cc",
        "context/base/base_context.cc",
    ],
    hdrs = [
        "context/base/cpu/cpu_context_impl.h",
        "context/base/base_context.h",
    ] + if_cuda_or_rocm([
        "context/stream_executor_based_impl.h"
    ]),
    copts = if_cuda_or_rocm([
        "-DTAO_RAL_USE_STREAM_EXECUTOR",
    ]),
    deps = [
        ":context_util",
        ":common_context",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_library",
        ":ral_logging",
        "@com_google_absl//absl/strings",
        "@curl",
        "//third_party/eigen3",
    ] + if_cuda_or_rocm([
        "//tensorflow/core:stream_executor_headers_lib",
    ]),
    alwayslink = 1,
    visibility = ["//visibility:public"],
)

disc_cc_library(
    name = "ral_base_cuda_context_impl",
    srcs = [
        "context/base/cuda/cuda_context_impl.cc",
    ],
    hdrs = [
        "context/base/cuda/cuda_context_impl.h",
    ],
    copts = ["-DTAO_RAL_USE_STREAM_EXECUTOR"],
    deps = [
        ":ral_base_cpu_context_impl",
        ":context_util",
        ":common_context",
        ":dynamic_sort",
        ":init_stream_executor",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_gpu_driver",
        ":ral_library",
        ":ral_logging",
        ":random",
        ":transpose",
        "//tensorflow/core:lib",
        "@com_google_absl//absl/strings",
        "@curl",
    ] + if_rocm_is_configured([
        "//tensorflow/stream_executor/rocm:rocm_platform",
        "//tensorflow/stream_executor/rocm:rocm_driver",
    ]) + if_cuda_is_configured([
        "//tensorflow/stream_executor/cuda:cuda_platform",
        "@local_config_cuda//cuda:cuda_driver",
    ]),
    alwayslink = 1,
    visibility = ["//visibility:public"],
)

tf_cc_shared_object(
    name = "libral_base_context.so",
    linkopts = select({
        "//conditions:default": [
            "-z defs",
            "-Wl,--version-script",  #  This line must be directly followed by the version_script.lds file
            "$(location //tensorflow/compiler/mlir/xla/ral:context_version_scripts.lds)",
        ],
    }),
    deps = [
        ":ral_base_cpu_context_impl",
        "//tensorflow/compiler/mlir/xla/ral:context_version_scripts.lds",
    ] + if_cuda_or_rocm([
        ":ral_base_cuda_context_impl",
    ]))

cc_library(
    name = "ral_base_context_lib",
    data = [
        ':libral_base_context.so',
    ],
    srcs = ["libral_base_context.so"],
    includes = [
        ".",
    ],
    visibility = ["//visibility:public"],
)

tf_gpu_kernel_library(
    name = "dynamic_sort_kernel",
    srcs = [
        "context/custom_library/dynamic_sort.cu.cc",
        "context/custom_library/tf_topk.cu.h",
    ],
    hdrs = [
        "context/custom_library/dynamic_sort.h",
        "context/custom_library/gpu_helper.h"
    ],
    copts = if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
    ]),
    deps = [
        "@com_google_absl//absl/base",
        "@com_google_absl//absl/types:optional",
    ] + if_cuda_is_configured([
        "@cub_archive//:cub",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
)

###########################################################################################
# The targets following are for tf bridge side build. Get rid of all the deps from tf source code, only use some of the `.bzl` utils from tensorflow.

cc_library(
    name = "common_context_bridge",
    srcs = [
        "context/common_context_impl.cc",
        "context/common_context_impl_pdll.cc",
    ] + if_cuda_or_rocm([
        "context/common_context_impl_cuda.cc",
        "context/stream_executor_based_impl.cc",
    ]) + if_cuda([
        "context/cuda_impl_sparse.cc",
        "context/quantized_gpu_kernel_impl.cc",
    ]) + if_patine([
        "context/common_context_impl_patine.cc",
    ]) + if_mkldnn([
        "context/common_context_impl_mkldnn.cc",
        "context/common_context_impl_quantization.cc",
    ]) + if_disc_aarch64([
        "context/common_context_impl_acl.cc",
    ]),
    hdrs = [
        "context/common_context_impl.h",
        "context/stream_executor_based_impl.h",
    ] + if_cuda_or_rocm([
    ])+ if_mkldnn([
        "context/common_context_impl_mkldnn.h",
    ]) + if_disc_aarch64([
        "context/common_context_impl_acl.h",
    ]),
    copts = [
        "-fopenmp",
        "-DDISC_BUILD_FROM_TF_BRIDGE"
    ] + if_cuda_or_rocm([
        "-DTAO_RAL_USE_STREAM_EXECUTOR"
    ]) + if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]),
    linkopts = [
        "-fopenmp",
        "-ldl",
        "-lm"
    ],
    deps = [
        ":pdll_util",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_gpu_driver",
        ":ral_logging",
        ":ral_metadata",
        ":context_util",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]) + if_blade_gemm([
        "@blade_gemm//:blade_gemm",
    ]) + if_mkldnn([
        ":disc_mkl_bazel",
        ":ral_md5",
    ]),
    alwayslink = 1,
)

cc_library(
    name = "ral_tf_context_bridge",
    srcs = [
        "context/tensorflow/tf_context_impl.cc",
        "context/tensorflow/tf_kernel_impl.cc",
    ],
    hdrs = [
        "context/tensorflow/tf_context_impl.h"
    ],
    copts = [
        "-DDISC_BUILD_FROM_TF_BRIDGE"
    ] + if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]),
    deps = [
        ":context_util",
        ":common_context_bridge",
        ":ral_context",
        ":ral_cpu_driver",
        ":ral_gpu_driver",
        ":ral_library",
        "@local_config_cuda//cuda:cuda_headers",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ],
    alwayslink = 1,
)

cuda_library(
    name = "dynamic_sort_kernel_bridge",
    srcs = [
        "context/custom_library/dynamic_sort.cu.cc",
        "context/custom_library/tf_topk.cu.h",
    ],
    hdrs = [
        "context/custom_library/dynamic_sort.h",
        "context/custom_library/gpu_helper.h"
    ],
    copts = [
        "-DDISC_BUILD_FROM_TF_BRIDGE"
    ] + if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]) + cuda_default_copts(),
    deps = [
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@cub_archive//:cub",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
)

cc_library(
    name = "dynamic_sort_bridge",
    srcs = [
        "context/dynamic_sort_impl.cc",
    ],
    hdrs = [
        "context/dynamic_sort_impl.h",
    ],
    copts = [
        "-DDISC_BUILD_FROM_TF_BRIDGE"
    ] + if_cuda_is_configured([
        "-DGOOGLE_CUDA=1",
    ]),
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_logging",
        ":context_util",
        ":common_context_bridge",
        ":dynamic_sort_kernel_bridge",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@local_config_cuda//cuda:cuda_driver",
    ]),
    alwayslink = 1,
)

cuda_library(
    name = "random_gpu_lib_bridge",
    srcs = [
        "context/custom_library/random_gpu.cu.cc",
    ],
    hdrs = [
        "context/custom_library/random.h",
        "context/custom_library/philox_random.h",
    ],
    copts = if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]) + cuda_default_copts(),
    deps = if_cuda_is_configured([
        "@cub_archive//:cub",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
)

cc_library(
    name = "random_bridge",
    srcs = [
        "context/random_impl.cc",
    ],
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_cpu_driver",
        ":ral_logging",
        ":context_util",
        ":random_gpu_lib_bridge",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
    alwayslink = 1,
)

cuda_library(
    name = "transpose_gpu_lib_bridge",
    srcs = [
        "context/custom_library/transpose_gpu.cu.cc",
        "context/custom_library/tf_transpose.cu.h",
    ],
    hdrs = [
        "context/custom_library/transpose.h",
        "context/custom_library/dimensions.h",
        "context/custom_library/gpu_helper.h"
    ] + if_cuda_is_configured([
        "context/stream_executor_based_impl.h"
    ]),
    copts = [
        "-DDISC_BUILD_FROM_TF_BRIDGE"
    ] + if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]) + if_cuda_or_rocm([
        "-DTAO_RAL_USE_STREAM_EXECUTOR"
    ]) + cuda_default_copts(),
    deps = [
        ":ral_context",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@cub_archive//:cub",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
)

cc_library(
    name = "transpose_bridge",
    srcs = [
        "context/transpose_impl.cc",
    ],
    copts = [
        "-DDISC_BUILD_FROM_TF_BRIDGE",
    ] + if_rocm_is_configured([
        "-DTENSORFLOW_USE_ROCM=1",
        "-x rocm",
    ]) + if_cuda_or_rocm([
        "-DTAO_RAL_USE_STREAM_EXECUTOR"
    ]) + cuda_default_copts(),
    deps = [
        ":ral_context",
        ":ral_gpu_driver",
        ":ral_cpu_driver",
        ":ral_logging",
        ":context_util",
        ":transpose_gpu_lib_bridge",
        "@local_config_tf//:libtensorflow_framework",
        "@local_config_tf//:tf_header_lib",
    ] + if_cuda_is_configured([
        "@local_config_cuda//cuda:cuda_driver",
        "@local_config_cuda//cuda:cuda_headers",
    ]) + if_rocm_is_configured([
        "@local_config_rocm//rocm:rocm_headers",
    ]),
    alwayslink = 1,
)

cc_library(
    name = "ral_bridge",
    deps = [
        ":common_context_bridge",
        ":ral_tf_context_bridge",
    ] + if_cuda_or_rocm([
        ":dynamic_sort_bridge",
        ":random_bridge",
        ":transpose_bridge",
    ]),
    alwayslink = 1,
)
